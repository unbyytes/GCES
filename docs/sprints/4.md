
# üìù Relat√≥rio de Contribui√ß√£o ‚Äì Sprint 4

**Disciplina:** Gest√£o de Configura√ß√£o e Evolu√ß√£o de Software

**Equipe:** OWASP (Times Blue e Red)

**Per√≠odo da Sprint:** 22/10/2025 - 19/11/2025

---

## 1. Objetivos da Sprint

#### Blue Team
- Estabelecer o Ambiente: Definir um fork oficial do projeto que servir√° como ambiente de desenvolvimento e testes para a implementa√ß√£o do pipeline.

- Integrar o Arsenal: Adicionar os seguintes jobs a um novo stage de seguran√ßa (security_scan) no arquivo .gitlab-ci.yml.

### Red Team

- Continuidade dos ataques coordenados sobre a EJ
    - Session Hijacking
  - Explora√ß√£o de vulnerabilidades Web.
- Estudo sobre novas ferramentas de ataques e verifica√ß√£o
    - GoPhish
    - MailHog
- Contribui√ß√£o para detec√ß√£o, explora√ß√£o controlada e solu√ß√£o de XSS na EJ-Application.

---

## 2. Entregas Coletivas

| Entrega             | Status (Conclu√≠do/Parcial/Pendente) | Link/Refer√™ncia        | Observa√ß√µes                       |
| ------------------- | ----------------------------------- | ---------------------- | --------------------------------- |
| Ataque de Session Hijacking sobre EJ | Conclu√≠do          |                        | Marcus V. & J√∫lio C√©sar           |
| Implementa√ß√£o das ferramentas de seguran√ßa na pipeline | Conclu√≠do          |                        | Ana Carol, Sebastian e Daniel           |
| Relatorio sobre a implementa√ß√£o e vulnerabilidades encontradas | Conclu√≠do          |                        | Miguel, Breno e Peixoto   |

---

## 3. Contribui√ß√µes Individuais

| Integrante    | Contribui√ß√µes                             | Links (PRs, Issues, Docs) | Observa√ß√µes |
| ------------- | ----------------------------------------- | ------------------------- | ----------- |
| Mateus Vieira | Fix do XSS na plataforma EJ | [MR #392](https://gitlab.com/pencillabs/ej/ej-application/-/merge_requests/392)  |                           |
| Miguel Arthur | -------- | ------------------------- | ----------- |
| Henrique Camelo Quenino | Testes de XSS refletido/armazenado, SQL Injection, headers/CORS e brute force na EJ-Application, com di√°rio t√©cnico detalhado da Sprint 4 | [Di√°rio Sprint 4](../diarios/221008098/4.md)        | 

---

## 4. Maiores Avan√ßos

#### Blue Team

## 1. Integra√ß√£o do Arsenal de Seguran√ßa no CI/CD

O principal marco desta sprint foi a transi√ß√£o do planejamento para a execu√ß√£o t√©cnica. O ambiente de **CI/CD do GitLab** foi configurado para executar verifica√ß√µes de seguran√ßa autom√°ticas a cada *push*, estabelecendo a primeira linha de defesa ativa do projeto.

### üîπ Cria√ß√£o do Est√°gio `security_scan`
Foi criado um novo est√°gio no arquivo **`.gitlab-ci.yml`**, dedicado exclusivamente √† execu√ß√£o de testes de seguran√ßa.

### üîπ Jobs Automatizados
As ferramentas selecionadas foram integradas com sucesso:

- **Gitleaks** ‚Äî para detec√ß√£o de segredos.  
- **Semgrep** ‚Äî para an√°lise est√°tica de c√≥digo (SAST).  
- **pip-audit** ‚Äî para an√°lise de vulnerabilidades em depend√™ncias (SCA).
- **Trivy** ‚Äî an√°lise de vulnerabilidades em *filesystem*, depend√™ncias e configura√ß√µes (SCA + Config Scan).
- 
Essas ferramentas agora garantem que o c√≥digo, as depend√™ncias e a busca por segredos sejam auditados continuamente a cada altera√ß√£o enviada ao reposit√≥rio.

---

## 2. Relat√≥rio T√©cnico de Implementa√ß√£o e Vulnerabilidades

Al√©m da configura√ß√£o da infraestrutura, a equipe executou a primeira rodada de an√°lises e registrou os resultados obtidos.

### üîπ Diagn√≥stico Inicial
Foi gerado um relat√≥rio completo detalhando como cada ferramenta foi integrada ao pipeline, incluindo:

- Configura√ß√µes realizadas no GitLab CI/CD  
- Est√°gios e jobs adicionados  
- Par√¢metros e flags utilizadas nas ferramentas  
- Fluxo de execu√ß√£o em commits e merge requests

### üîπ An√°lise de Achados
As primeiras vulnerabilidades identificadas foram analisadas e documentadas, constituindo a base de dados inicial para as pr√≥ximas a√ß√µes de **hardening**.

Entre os achados iniciais, destacam-se:

- Resultados de detec√ß√£o de segredos (Gitleaks)  
- Vulnerabilidades em bibliotecas registradas pelo pip-audit  
- Alertas de c√≥digo potencialmente inseguro encontrados pelo Semgrep  

Este mapeamento permitir√° direcionar as corre√ß√µes nas pr√≥ximas sprints, priorizando os riscos mais cr√≠ticos.

---

### Red Team

#### PR de fix sobre XSS

Tendo em vista a [Issue #1505](https://gitlab.com/pencillabs/ej/ej-application/-/issues/1505), o qual foi aberta durante a sprint 3, com o objetivo de reportar a falha de XSS identificada sobre a plataforma EJ. Agora, na sprint 4 foi realizado o MR com a proposta de solu√ß√£o para tal problema de vulnerabilidade, o mesmo pode ser identificado por: [MR #392](https://gitlab.com/pencillabs/ej/ej-application/-/merge_requests/392).

#### Solu√ß√£o do XSS

Ap√≥s estudos e testes, a solu√ß√£o foi implementada diretamente nos m√©todos *clean_welcome_message* e *clean_ending_message* do formul√°rio de conversa√ß√£o:

```python
def _clean_html_field(self, field_name):
    data = self.cleaned_data.get(field_name, "")
    return nh3.clean(
        data,
        attributes={
            "*": {"style", "href"}
        },
        filter_style_properties={"color", "font-weight", "text-align", "background-color"}
    )

def clean_welcome_message(self):
    return self._clean_html_field("welcome_message")

def clean_ending_message(self):
    return self._clean_html_field("ending_message")
```

---

#### Contribui√ß√µes de Teste e Valida√ß√£o

##### Testes de XSS (Cross-Site Scripting)

- Objetivo: validar se campos de busca e componentes da EJ-Application refletiam ou armazenavam conte√∫do potencialmente malicioso sem sanitiza√ß√£o adequada.
- Procedimento: sess√£o autenticada obtida via navegador, exportando manualmente cookies (`csrftoken`, `sessionid`, `show_welcome_window`) e usando-os em requisi√ß√µes curl contra o endpoint `/conversations/tags/promoted/` com payloads como `"><script>alert('XSS')</script>`.
- Resultado: as respostas HTTP 200 retornaram o payload codificado como texto, sem execu√ß√£o de scripts, indicando uso consistente de output encoding/sanitiza√ß√£o na camada de apresenta√ß√£o.

##### Testes de SQL Injection

- Objetivo: avaliar se par√¢metros de busca eram concatenados em SQL permitindo inje√ß√£o.
- Procedimento: envio de payloads como `' OR '1'='1` via curl autenticado para o mesmo endpoint de busca, salvando as respostas em arquivos HTML para an√°lise detalhada.
- Resultado: n√£o foram observados erros de banco, vazamento de mensagens SQL, altera√ß√µes indevidas em resultados ou bypass de l√≥gica, sugerindo uso de prepared statements e valida√ß√£o adequada no backend.

##### Valida√ß√£o de Headers de Seguran√ßa e CORS

- Foi realizada inspe√ß√£o de headers com curl autenticado em `/profile/`, confirmando presen√ßa de `X-Frame-Options: SAMEORIGIN` e `X-Content-Type-Options: nosniff`, mas aus√™ncia de `Content-Security-Policy` e `Strict-Transport-Security`, o que indica oportunidade de hardening adicional.
- Para CORS, requisi√ß√µes com `Origin: https://malicious.com` em `/api/v1/users/` retornaram 401 sem exposi√ß√£o de recursos cross-origin, indicando pol√≠tica de CORS alinhada ao modelo de autentica√ß√£o.

##### Testes de Rate Limiting e For√ßa Bruta

- Foram desenvolvidos scripts em bash e Python (com `requests` e BeautifulSoup) para automatizar login com CSRF v√°lido e sess√£o persistente, buscando simular tentativas repetidas de autentica√ß√£o.
- Na pr√°tica, o fluxo de autentica√ß√£o da EJ, com valida√ß√£o r√≠gida de CSRF e cookies de sess√£o, dificultou a execu√ß√£o de ataques de brute force em escala direta via curl, o que evidencia robustez do mecanismo de autentica√ß√£o, ainda que sem evid√™ncia expl√≠cita de respostas `429`.

---


#### Ataque Session Hijacking

Foi realizado um ataque de Session Hijacking bem sucedido (encontrou uma falha) na aplica√ß√£o EJ, a falha acontece porque o cookie sessionid n√£o possui flag Secure ativada, possibilitando que um atacante roube o valor do cookie para logar como se fosse a v√≠tima (roubo de sess√£o)

Para a execu√ß√£o do ataque √© preciso simular uma v√≠tima e um atacante, a m√°quina v√≠tima √© uma m√°quina virtual rodando Kali Linux com network modo Bridge, a m√°quina host √© o atacante, a v√≠tima loga no site normalmente usando seu email e senha, o atacante intercepta a requisi√ß√£o http usando alguma ferramenta de sniffing como tcpdump ou Wireshark, copia o valor do sessionid e cria um cookie com o valor copiado, ao dar reload ele estar√° logado como a v√≠tima.

<iframe width="1840" height="1035" src="https://www.youtube.com/embed/e-4RuBKNYBE" title="Ataque de Session Hijacking EJ Application" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## 5. Maiores Dificuldades

#### Blue Team

- Implementar as ferramentas no arquivo .yml do projeto

### Red Team

- N√£o foram identificadas dificuldades por parte do red team.

---

## 6. Li√ß√µes Aprendidas

#### Blue Team

1. **Integra√ß√£o de Seguran√ßa √© Mais Eficiente Quando Automatizada**  
   A inclus√£o dos scans no CI/CD demonstrou que falhas e segredos s√£o identificados mais cedo, reduzindo retrabalho e riscos acumulados.

2. **Ferramentas Complementares S√£o Essenciais**  
   Cada ferramenta cobre uma superf√≠cie diferente (SAST, SCA, secrets, IaC). Us√°-las em conjunto aumenta a profundidade da an√°lise e reduz pontos cegos.


### Red Team

- Realiza√ß√£o do ataque do tipo Session Hijacking
- Como utilizar bibliotecas de sanitiza√ß√£o de strings com HTML em Python para remover tags inseguras
- Aprendizado pr√°tico de como replicar a navega√ß√£o de um usu√°rio real via cookies, CSRF e scripts personalizados, para testar XSS, SQLi e brute force em ambiente autenticado.

---

## 7. Planejamento para a Pr√≥xima Sprint

* Abrir o MR para atualizar a pipeline
* Mudar da detec√ß√£o para a preven√ß√£o e mitiga√ß√£o, aplicando melhorias de seguran√ßa diretamente na configura√ß√£o da aplica√ß√£o (Django) e da infraestrutura como c√≥digo (Dockerfile).
* Entender como funciona o scan de imagens Docker e a diferen√ßa entre vulnerabilidades do S.O. e da aplica√ß√£o.
* Pesquisar sobre o que √© um Web Application Firewall (WAF) e comparar as principais solu√ß√µes open-source (ex: ModSecurity) e de provedores de nuvem.


### Red Team

* Ataque coordenado contra Blue Team:
    * Pipeline
* Documentar TTPs no formato MITRE ATT&CK
