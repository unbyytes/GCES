# Diário de Bordo – Pedro Luiz Fonseca da Silva

**Disciplina:** Gerência de Configuração e Evolução de Software  
**Equipe:** OWASP Red Team  
**Comunidade/Projeto de Software Livre:** Pencil Labs / EJ-Application  

---

## Sprint 5 – 19/11/2025 – 02/12/2025

### Resumo da Sprint

Nesta sprint, o foco foi sair apenas da análise teórica das vulnerabilidades e dar um passo em direção à **proposição de solução**.  
Escolhi trabalhar em cima da vulnerabilidade de XSS já registrada publicamente na EJ-Application (issue `#1505`), com o objetivo de:

- Entender melhor o fluxo de dados que permite a execução do XSS.  
- Estudar o código responsável pela sanitização de HTML.  
- Estruturar uma **proposta simples de reforço de segurança**, em um documento próprio, que pode ser usada como base para um futuro MR.

---

### Atividades Realizadas

| Data  | Atividade                                                                                  | Tipo       | Status      |
|-------|--------------------------------------------------------------------------------------------|-----------|-------------|
| 21/11 | Leitura detalhada da issue `#1505` de XSS e entendimento do cenário descrito               | Estudo     | Concluído   |
| 23/11 | Atualização do fork da EJ-Application e criação de branch local para estudo                | Código     | Concluído   |
| 25/11 | Localização e leitura das funções de sanitização de HTML no backend                        | Estudo     | Concluído   |
| 27/11 | Estudo da documentação da biblioteca `nh3` (sanitização de HTML em Python)                 | Estudo     | Concluído   |
| 30/11 | Escrita de um documento Markdown com proposta de reforço de segurança para o XSS           | Documento  | Concluído   |

---

### Sistema Usado

- Fork local da EJ-Application atualizado a partir do repositório oficial.  
- Ambiente Docker configurado nas sprints anteriores.  
- VS Code para navegação e leitura dos arquivos Python/Django.

---

### Ferramentas

- `git` para atualizar o fork e criar branch de estudo.  
- Editor Markdown para produzir a proposta de solução.  
- Documentação da biblioteca `nh3`.  

---

### Descrição da Atividade Técnica

1. **Leitura da issue `#1505` (XSS):**  
   Revisei o cenário do XSS persistente que ocorre em campos Rich Text — conteúdo HTML enviado pelo usuário é armazenado e posteriormente exibido sem sanitização suficiente.

2. **Análise das funções de sanitização existentes:**  
   No fork local, busquei por funções que processam HTML antes de salvar no banco.  
   Foi possível identificar a função responsável pela sanitização, com utilização de `nh3`, que atualmente permite alguns atributos e estilos que podem ampliar a superfície de ataque.

   def _clean_html_field(self, field_name):
    data = self.cleaned_data.get(field_name, "")
    return nh3.clean(
        data,
        attributes={"*": {"style", "href"}},
        filter_style_properties={"color", "font-weight", "text-align", "background-color"},
    )


3. **Estudo aprofundado da biblioteca `nh3`:**  
   Foquei nos seguintes pontos:
   - Tags permitidas por padrão  
   - Como limitar a whitelist de tags  
   - Como definir atributos seguros por tag  
   - Como evitar abuso de CSS (injeção via `style`)  
   - Uso de `strip=True` para remoção automática de elementos proibidos  

4. **Proposta de reforço de sanitização:**
   Produzi um documento (`xss-hardening-proposta.md`) contendo:
   - Contexto da vulnerabilidade  
   - Riscos do modelo atual  
   - Benefícios de uma whitelist mais restritiva  
   - Sugestão de implementação com lista explícita de tags e atributos permitidos  
   - Recomendação para padronizar o uso da mesma função de sanitização em **todos** os campos Rich Text  

  ALLOWED_TAGS = {"b", "strong", "i", "em", "u", "a", "p", "ul", "ol", "li", "br"}
ALLOWED_ATTRS = {
    "a": {"href", "title", "target"},
}

def _clean_html_field(self, field_name):
    data = self.cleaned_data.get(field_name, "")
    return nh3.clean(
        data,
        tags=ALLOWED_TAGS,
        attributes=ALLOWED_ATTRS,
        strip=True,
    )


---

### Resultado

- Estruturei uma proposta técnica simples e prática para reforçar a sanitização de HTML no EJ.  
- Aprendi como o fluxo de entrada/exibição de HTML funciona internamente na aplicação.  
- A atividade serviu como preparação para criação de um MR no futuro.  

---

### Maiores Dificuldades

- Determinar quais tags HTML são realmente necessárias para o funcionamento normal do painel administrativo.  
- Identificar todos os locais da aplicação onde conteúdo Rich Text é aceito e processado.  

---

### Aprendizados

- Sanitização deve ser tratada como política global e padronizada.  
- Mesmo bibliotecas robustas precisam ser configuradas corretamente para manter segurança.  
- Trabalhar com uma issue real conecta teoria e prática de forma direta.  

---

